#
# @configure_input@
#

CC      = @CC@
CFLAGS := $(CFLAGS) -g -W -Wall -Wextra -std=c99
SHELL   = @SHELL@

prefix  = @prefix@
includedir = @includedir@
libdir = @libdir@

# every .c file
OBJECTS = $(patsubst %.c,%.o,$(wildcard *.c))

LIBS = @LIBS@

.PHONY: libs test install uninstall clean distclean
# the executable
nemo: libnemo.so libs
	$(CC) $(CFLAGS) -L. -o nemo -lnemo $(LIBS)

# Nemo's main library, the one that gets linked with third-party libraries
libnemo.so: $(OBJECTS)
	$(CC) $(CFLAGS) $(OBJECTS) -shared -Wl,-soname,libnemo.so -o libnemo.so $(LIBS)

%.o: %.c *.h
	$(CC) $(CFLAGS) -fPIC -c $< -o $@

# the standard libraries
libs: libnemo.so
	@cd lib; $(MAKE)

# test cases
test:
	@$(SHELL) test/runner.sh

install: nemo
	mkdir -p $(libdir)/nemo
	install -m 755 lib/*.so $(libdir)/nemo/
	install -m 755 lib*.so $(libdir)
	mkdir -p $(includedir)/nemo
	install -m 644 *.h $(includedir)/nemo
	install -m 755 nemo $(bindir)/nemo

uninstall:
	rm -rf $(libdir)/libnemo*
	rm -rf $(libdir)/nemo
	rm -rf $(includedir)/nemo
	rm -rf $(bindir)/nemo

clean:
	rm -f *.o
	rm -f *.so*
	@cd lib; $(MAKE) clean

distclean: clean
	rm -f nemo

