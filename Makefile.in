#
# @configure_input@
#

CC      = @CC@
CFLAGS := $(CFLAGS) -g -W -Wall -Wextra -std=c99 -O2
SHELL   = @SHELL@

prefix = @prefix@
exec_prefix = @exec_prefix@
includedir = @includedir@
libdir = @libdir@
bindir = @bindir@

# libnemos version
LIBNEMO_VMAJOR = 0
LIBNEMO_VMINOR = 2

# every .c file
OBJECTS = $(patsubst %.c,%.o,$(wildcard *.c))

LIBS = @LIBS@

.PHONY: libs test install uninstall clean distclean
# the executable
nemo: libnemo.so libs
	$(CC) $(CFLAGS) $(OBJECTS) -o nemo $(LIBS)

# Nemo's main library, the one that gets linked with third-party libraries
libnemo.so: $(OBJECTS)
	$(CC) $(CFLAGS) $(OBJECTS) -shared -Wl,-soname,libnemo.so.$(LIBNEMO_VMAJOR) -o libnemo.so.$(LIBNEMO_VMAJOR).$(LIBNEMO_VMINOR) $(LIBS)
	ln -sf libnemo.so.$(LIBNEMO_VMAJOR).$(LIBNEMO_VMINOR) libnemo.so.$(LIBNEMO_VMAJOR)
	ln -sf libnemo.so.$(LIBNEMO_VMAJOR) libnemo.so

%.o: %.c *.h
	$(CC) $(CFLAGS) -fPIC -c $< -o $@

# the standard libraries
libs: libnemo.so
	@cd lib; $(MAKE)

# test cases
test:
	@$(SHELL) test/runner.sh

install: nemo
	mkdir -p $(libdir)/nemo
	install -m 755 lib/*.so $(libdir)/nemo/
	install -m 755 libnemo.so.$(LIBNEMO_VMAJOR).$(LIBNEMO_VMINOR) $(libdir)
	ln -sf $(libdir)/libnemo.so.$(LIBNEMO_VMAJOR).$(LIBNEMO_VMINOR) $(libdir)/libnemo.so.$(LIBNEMO_VMAJOR)
	ln -sf $(libdir)/libnemo.so.$(LIBNEMO_VMAJOR) $(libdir)/libnemo.so
	mkdir -p $(includedir)/nemo
	install -m 644 *.h $(includedir)/nemo
	install -m 755 nemo $(bindir)/nemo

uninstall:
	rm -rf $(libdir)/libnemo*
	rm -rf $(libdir)/nemo
	rm -rf $(includedir)/nemo
	rm -rf $(bindir)/nemo

clean:
	rm -f *.o
	rm -f *.so*
	@cd lib; $(MAKE) clean

distclean: clean
	rm -f nemo

