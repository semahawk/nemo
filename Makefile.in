#
# @configure_input@
#

CC      = gcc
CFLAGS := $(CFLAGS) -g -W -Wall -Wextra -std=c99
SHELL   = @SHELL@

LIBDIR = @libdir@
PREFIX  = @prefix@

# every .c file
OBJECTS = $(patsubst %.c,%.o,$(wildcard *.c))

LIBS = -lnemo @LIBS@

.PHONY: libs test install uninstall clean distclean
# the executable
nemo: libnemo.so libs
	$(CC) $(CFLAGS) -L. $(LIBS) -o nemo

# Nemo's main library, the one that gets linked with third-party libraries
libnemo.so: $(OBJECTS)
	$(CC) $(CFLAGS) $(OBJECTS) -shared -Wl,-soname,libnemo.so -o libnemo.so

# yup, every .c file should have it's own .h file
%.o: %.c *.h
	$(CC) $(CFLAGS) -fPIC -c $< -o $@

# the standard libraries
libs: libnemo.so
	@cd lib; make

# test cases
test:
	@$(SHELL) test/runner.sh

install: nemo
	mkdir -p $(LIBDIR)/nemo
	install -m 755 lib/*.so $(LIBDIR)/nemo/
	install -m 755 lib*.so $(LIBDIR)
	install -m 755 nemo $(PREFIX)/bin/nemo

uninstall:
	rm -rf $(LIBDIR)/libnemo*
	rm -rf $(LIBDIR)/nemo
	rm -rf $(PREFIX)/bin/nemo

clean:
	rm -f *.o
	rm -f *.so*
	@cd lib; make clean

distclean: clean
	rm -f nemo

