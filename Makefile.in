#
# @configure_input@
#

CC      = gcc
CFLAGS := $(CFLAGS) -g -W -Wall -Wextra -std=c99
SHELL   = @SHELL@

LIBDIR = @libdir@
PREFIX  = @prefix@

OBJECTS  = nemo.o object.o lexer.o parser.o error.o debug.o mem.o ast.o builtin.o scope.o int.o float.o string.o null.o array.o

LIBS = -lnemo @LIBS@

.PHONY: libs test install uninstall clean distclean
nemo: libnemo.so libs
	$(CC) $(CFLAGS) -L. $(LIBS) -o nemo

libnemo.so: $(OBJECTS)
	$(CC) $(CFLAGS) $(OBJECTS) -shared -Wl,-soname,libnemo.so -o libnemo.so

%.o: %.c *.h
	$(CC) $(CFLAGS) -fPIC -c $< -o $@

libs: libnemo.so
	@cd lib; make

test:
	@$(SHELL) test/runner.sh

install: nemo
	mkdir -p $(LIBDIR)/nemo
	install -m 755 lib/*.so $(LIBDIR)/nemo/
	install -m 755 lib*.so $(LIBDIR)
	install -m 755 nemo $(PREFIX)/bin/nemo

uninstall:
	rm -rf $(LIBDIR)/libnemo*
	rm -rf $(LIBDIR)/nemo
	rm -rf $(PREFIX)/bin/nemo

clean:
	rm -f *.o
	rm -f *.so*
	@cd lib; make clean

distclean: clean
	rm -f nemo

